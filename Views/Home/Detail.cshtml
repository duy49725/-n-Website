@model IQueryable<DoAnWebNangCao.Models.Book>

@{
    ViewData["Title"] = "Book Detail";
    Layout = "~/Views/Shared/_LayoutClient.cshtml";
}
<section id="prodetails" class="section-p1">
    @foreach (var book in Model)
    {
        <div class="single-pro-image">
            <img src="/Uploads/@book.Image" width="100%" id="MainImg" alt="">
        </div>

        <div class="single-pro-details">
            <h6>@book.BookName</h6>
            <h2><strong>Price:</strong>@book.Price</h2>
            <h3>Genres:</h3>
            <p>@book.GenreNames</p>
            <h3>Publisher:</h3>
            <p>@book.PublisherName</p>
            <h3>Authors:</h3>
            <p>@book.AuthorNames</p>
            <p>Average Score: @book.AverageRating</p>
            <p><strong>Release Year:</strong> @book.ReleaseYear</p>
            <input type="number" value="1">
            <button class="normal" onclick="add(@book.Id)">Add To Cart</button>
            <h4>Product Details</h4>
            <p style="width: 300px; flex-wrap: wrap;">
                @Html.Raw(@book.Describle)
            </p>
        </div>
    }
</section>
<section id="product1" class="section-p1">
    <h2>Featured Products</h2>
    <p>Summer Collection New Mordern Design</p>
    <div class="pro-container">
        @foreach (var book in ViewBag.RelatedBooks)
        {
            <a class="btn btn-secondary btn-sm" asp-action="Detail" asp-route-id="@book.Id">
                <div class="pro" onclick="redirectToDetail(@book.Id)">
                    <img style="width:100%;height:200px" src="/Uploads/@book.Image" alt="...">
                    <div class="des">
                        <span>Tên Sách: @book.BookName</span>
                        <div class="star">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                        </div>
                        <h4>Giá: @book.Price</h4>
                    </div>
                    <a href="#" class="cart" onclick="add(@book.Id)"><i class="fa-solid fa-cart-arrow-down"></i></a>
                </div>
            </a>
        }
    </div>
</section>
<!-- Hiển thị form để người dùng đánh giá -->
@foreach (var book in Model)
{
  <div class="allReView">
        <h3>Reviews:</h3>
        <div class="review-container" id="reviewsContainer">
            @if (book.Reviews != null && book.Reviews.Any())
            {
                @foreach (var review in book.Reviews)
                {
                    <div class="review">
                        <div class="rating">
                            @for (int i = 0; i < review.Rating; i++)
                            {
                                <i class="fas fa-star"></i>
                            }
                        </div>
                        <p class="comment">@review.Comment</p>
                        <p class="username">By: @review.UserName</p>
                        <p class="timestamp">Posted on: @review.CreatedAt.ToString("MM/dd/yyyy")</p>
                    </div>
                }
            }
            else
            {
                <p class="no-review">No reviews yet.</p>
            }
        </div>
        @if (User.Identity.IsAuthenticated)
        {
            <h3>Write a Review:</h3>
            <partial name="ReviewPartial.cshtml" model="new BookReview { BookId = book.Id }" />
        }
        else
        {
            <p>Please <a asp-controller="Account" asp-action="Login">login</a> to write a review.</p>
        }
  </div>
}

@section Scripts{
    <script>
        async function add(bookId) {
            var usernameEl = document.getElementById("username");
            if (usernameEl == null) {
                window.location.href = "/Identity/Account/Login";
                //var username=usernameEl.innerText;
                //  if(username.length<1){
                //      window.location.href="/Identity/Account/Login";
                //  }
            }
            try {
                var response = await fetch(`/Cart/AddItem?bookId=${bookId}`);
                console.log(bookId)
                if (response.status == 200) {
                    var result = await response.json();
                    var cartCountEl = document.getElementById("cartCount");
                    cartCountEl.innerHTML = result;
                    window.location.href = "#cartCount";
                }
            }
            catch (err) {
                console.log(err);
            }
        }
    </script>
}

<style>
    .allReView{
        margin: 20px;
    }

    .review-container {
        margin-top: 20px;
        border-top: 1px solid #ccc;
        padding-top: 20px;
    }

    .review {
        border-bottom: 1px solid #ccc;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }

    .rating {
        color: #ffa726;
        margin-bottom: 10px;
    }

        .rating i {
            font-size: 20px;
            margin-right: 5px;
        }

    .comment {
        margin-bottom: 10px;
    }

    .username {
        color: #777;
        font-style: italic;
    }

    .timestamp {
        color: #777;
        font-size: 12px;
    }

    .no-review {
        color: #777;
        margin-top: 20px;
    }

    .write-review-container {
        margin-top: 30px;
        border-top: 1px solid #ccc;
        padding-top: 20px;
    }

    .write-review-header {
        margin-bottom: 20px;
    }

    .write-review-link {
        color: #007bff;
    }

        .write-review-link:hover {
            text-decoration: underline;
        }
</style>